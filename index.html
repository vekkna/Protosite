<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Wargame Prototype</title>
        <style>
            body {
                font-family: sans-serif;
                background-color: #222;
                color: #ccc;
                margin: 0;
                padding: 20px;
                display: flex;
                justify-content: center;
                height: 100vh;
                overflow: hidden;
                user-select: none;
            }

            #container {
                display: flex;
                gap: 20px;
            }

            /* --- SIDEBARS --- */
            .sidebar {
                width: 150px;
                background-color: #444;
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                border: 2px solid #555;
                text-align: center;
            }

            .palette-item {
                padding: 15px;
                font-weight: bold;
                color: white;
                cursor: grab;
                border: 2px solid rgba(255, 255, 255, 0.2);
                margin-bottom: 5px;
            }

            .palette-item:hover {
                border-color: white;
            }

            /* --- DICE --- */
            #dice-btn {
                padding: 20px;
                background-color: #d32f2f;
                color: white;
                font-size: 1.2em;
                font-weight: bold;
                border: 2px solid white;
                cursor: pointer;
                margin-top: 20px;
            }

            #dice-btn:active {
                background-color: #b71c1c;
            }

            #dice-result {
                font-size: 3em;
                font-weight: bold;
                color: white;
                margin: 10px 0 0 0;
            }

            #dice-detail {
                font-size: 0.9em;
                color: #aaa;
            }

            /* --- TABLE --- */
            #game-table {
                position: relative;
                background-color: #35654d;
                /* Felt Green */
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
                overflow: hidden;
                cursor: crosshair;
            }

            /* --- UNITS --- */
            .unit {
                position: absolute;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                font-weight: bold;
                font-size: 12px;
                /* Reduced to fit text */
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.8);
                box-sizing: border-box;
                cursor: grab;
                z-index: 10;
                background-color: #555;
                transition: transform 0.1s ease-out;
                padding: 2px;
                line-height: 1.1;
            }

            .wound-marker {
                position: absolute;
                top: -10px;
                right: -10px;
                background-color: #d32f2f;
                color: white;
                border: 2px solid white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 15;
                display: none;
            }

            /* --- TERRAIN --- */
            .terrain {
                position: absolute;
                opacity: 0.9;
                cursor: grab;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                text-shadow: 1px 1px 2px black;
                box-sizing: border-box;
                z-index: 5;
                transition: transform 0.1s ease-out;
            }

            .terrain.forest {
                background-color: #1b5e20;
                border: 2px dashed #4caf50;
                border-radius: 50%;
            }

            .terrain.hills {
                background-color: #795548;
                border: 2px solid #3e2723;
                /* Organic Blob */
                border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            }

            .terrain.rough {
                background-color: #9e9d24;
                border: 2px dotted #f0f4c3;
                /* Jagged/Irregular Blob */
                border-radius: 20% 80% 40% 60% / 60% 40% 70% 30%;
            }

            /* --- UI LAYER --- */
            #ui-layer {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 20;
            }

            #measure-line {
                stroke: yellow;
                stroke-width: 3;
                stroke-dasharray: 10, 5;
                opacity: 0;
            }

            #measure-text {
                font-size: 18px;
                font-weight: bold;
                fill: yellow;
                text-shadow: 1px 1px 2px black;
                opacity: 0;
            }
        </style>
    </head>

    <body>
        <div id="container">
            <div class="sidebar">
                <h3 style="margin-top:0">Tools</h3>
                <div id="dice-btn" onclick="rollDice()">Roll 2d6</div>
                <div id="dice-result">-</div>
                <div id="dice-detail"></div>
            </div>
            <div id="game-table">
                <svg id="ui-layer">
                    <line id="measure-line" x1="0" y1="0" x2="0" y2="0" />
                    <text id="measure-text" x="0" y="0">0"</text>
                </svg>
            </div>
            <div class="sidebar">
                <h3 style="margin-top:0">Terrain</h3>
                <div class="palette-item" style="background-color: #1b5e20;" onmousedown="spawnTerrain('forest')">Forest
                </div>
                <div class="palette-item" style="background-color: #795548;" onmousedown="spawnTerrain('hills')">Hills
                </div>
                <div class="palette-item" style="background-color: #9e9d24;" onmousedown="spawnTerrain('rough')">Rough
                </div>
                <div style="margin-top:auto; font-size: 0.8em; color: #888; text-align: left;">
                    <p><strong>Controls:</strong></p>
                    <p>- Drag Unit to move</p>
                    <p>- Click empty space to measure</p>
                    <p>- Hover Unit: +/- Wounds</p>
                    <p>- Hover Terrain: +/- Size</p>
                    <p>- Wheel: Rotate</p>
                </div>
            </div>
        </div>
        <script>
            // --- CONFIGURATION ---
            const SCALE = 20;
            const TABLE_WIDTH_FT = 4;
            const TABLE_DEPTH_FT = 3;
            const UNIT_WIDTH_MM = 88;
            const UNIT_DEPTH_MM = 63;
            const DEPLOY_INCHES = 6;
            const TERRAIN_DEFAULT_W = 6;
            const TERRAIN_DEFAULT_H = 4;

            // --- CONVERSIONS ---
            const mmToInches = (mm) => mm / 25.4;
            const inchesToPx = (inch) => inch * SCALE;
            const pxToInches = (px) => (px / SCALE).toFixed(1);

            const tableWidthPx = inchesToPx(TABLE_WIDTH_FT * 12);
            const tableHeightPx = inchesToPx(TABLE_DEPTH_FT * 12);
            const unitWidthPx = inchesToPx(mmToInches(UNIT_WIDTH_MM));
            const unitHeightPx = inchesToPx(mmToInches(UNIT_DEPTH_MM));

            // --- SETUP TABLE ---
            const table = document.getElementById('game-table');
            table.style.width = `${tableWidthPx}px`;
            table.style.height = `${tableHeightPx}px`;

            // --- STATE MANAGEMENT ---
            let activePiece = null;   // Object being dragged (Unit OR Terrain)
            let isMeasuring = false;  // Flag for empty ground measurement
            let startX = 0;
            let startY = 0;

            let hoveredUnit = null;
            let hoveredTerrain = null;

            const lineElement = document.getElementById('measure-line');
            const textElement = document.getElementById('measure-text');

            // --- DICE ROLLER ---
            function rollDice() {
                const d1 = Math.floor(Math.random() * 6) + 1;
                const d2 = Math.floor(Math.random() * 6) + 1;
                document.getElementById('dice-result').innerText = d1 + d2;
                document.getElementById('dice-detail').innerText = `(${d1} + ${d2})`;
            }

            // --- INITIALIZE UNITS ---
            function createUnits() {
                const sides = ['red', 'blue'];
                const unitNames = [
                    "Cavalry",
                    "Mounted Archers",
                    "Archers",
                    "Swords",
                    "Spears",
                    "Skirmishers"
                ];

                const deployYPositions = [
                    inchesToPx(DEPLOY_INCHES),
                    tableHeightPx - inchesToPx(DEPLOY_INCHES)
                ];

                sides.forEach((color, sideIndex) => {
                    const yPos = deployYPositions[sideIndex];
                    const spacing = tableWidthPx / 7;

                    unitNames.forEach((name, i) => {
                        const div = document.createElement('div');
                        div.classList.add('unit');
                        div.style.backgroundColor = color;
                        div.style.width = `${unitWidthPx}px`;
                        div.style.height = `${unitHeightPx}px`;

                        // Position based on index (i+1 because we want padding on left)
                        div.style.left = `${(spacing * (i + 1)) - (unitWidthPx / 2)}px`;
                        div.style.top = `${yPos - (unitHeightPx / 2)}px`;

                        div.innerText = name;

                        div.dataset.angle = "0";
                        div.dataset.wounds = "0";

                        const marker = document.createElement('div');
                        marker.classList.add('wound-marker');
                        marker.innerText = "0";
                        div.appendChild(marker);

                        attachCommonListeners(div);
                        div.addEventListener('mouseenter', () => hoveredUnit = div);
                        div.addEventListener('mouseleave', () => hoveredUnit = null);

                        table.appendChild(div);
                    });
                });
            }

            // --- TERRAIN SPAWNER ---
            window.spawnTerrain = function (type) {
                const div = document.createElement('div');
                div.classList.add('terrain', type);
                div.innerText = type.charAt(0).toUpperCase() + type.slice(1);
                div.style.width = `${inchesToPx(TERRAIN_DEFAULT_W)}px`;
                div.style.height = `${inchesToPx(TERRAIN_DEFAULT_H)}px`;
                div.dataset.angle = "0";

                attachCommonListeners(div);
                div.addEventListener('mouseenter', () => hoveredTerrain = div);
                div.addEventListener('mouseleave', () => hoveredTerrain = null);

                table.appendChild(div);

                activePiece = div;
                div.style.left = '0px'; div.style.top = '0px';
                startX = -9999;
            };

            function attachCommonListeners(element) {
                element.addEventListener('mousedown', onPieceDragStart);
                element.addEventListener('wheel', onWheel);
            }

            // --- KEYBOARD HANDLING ---
            window.addEventListener('keydown', (e) => {
                const isPlus = (e.key === '+' || e.key === '=' || e.code === 'NumpadAdd');
                const isMinus = (e.key === '-' || e.key === '_' || e.code === 'NumpadSubtract');

                if (!isPlus && !isMinus) return;

                if (hoveredUnit) {
                    let wounds = parseInt(hoveredUnit.dataset.wounds);
                    const marker = hoveredUnit.querySelector('.wound-marker');
                    if (isPlus) wounds++;
                    if (isMinus && wounds > 0) wounds--;
                    hoveredUnit.dataset.wounds = wounds;
                    marker.innerText = wounds;
                    marker.style.display = (wounds > 0) ? 'flex' : 'none';
                }
                else if (hoveredTerrain) {
                    let w = parseFloat(hoveredTerrain.style.width) || hoveredTerrain.getBoundingClientRect().width;
                    let h = parseFloat(hoveredTerrain.style.height) || hoveredTerrain.getBoundingClientRect().height;
                    const factor = isPlus ? 1.1 : 0.9;
                    hoveredTerrain.style.width = `${w * factor}px`;
                    hoveredTerrain.style.height = `${h * factor}px`;
                }
            });

            // --- INTERACTION LOGIC ---

            // 1. Dragging a Unit or Terrain
            function onPieceDragStart(e) {
                if (e.button !== 0) return;
                e.stopPropagation();

                activePiece = e.currentTarget;
                const rect = activePiece.getBoundingClientRect();
                const tableRect = table.getBoundingClientRect();

                startX = (rect.left - tableRect.left) + (rect.width / 2);
                startY = (rect.top - tableRect.top) + (rect.height / 2);

                showLine(startX, startY);
            }

            // 2. Clicking Empty Ground (Measuring)
            table.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                if (e.target !== table && e.target !== document.getElementById('ui-layer')) return;

                isMeasuring = true;
                const tableRect = table.getBoundingClientRect();
                startX = e.clientX - tableRect.left;
                startY = e.clientY - tableRect.top;

                showLine(startX, startY);
            });

            function showLine(x, y) {
                lineElement.style.opacity = 1;
                textElement.style.opacity = 1;
                lineElement.setAttribute('x1', x);
                lineElement.setAttribute('y1', y);
                lineElement.setAttribute('x2', x);
                lineElement.setAttribute('y2', y);
                textElement.innerHTML = '0"';
            }

            function onMouseMove(e) {
                if (!activePiece && !isMeasuring) return;

                const tableRect = table.getBoundingClientRect();
                let mouseX = e.clientX - tableRect.left;
                let mouseY = e.clientY - tableRect.top;

                if (activePiece) {
                    const rect = activePiece.getBoundingClientRect();
                    activePiece.style.left = `${mouseX - (rect.width / 2)}px`;
                    activePiece.style.top = `${mouseY - (rect.height / 2)}px`;
                }

                if (startX > -1000) {
                    lineElement.setAttribute('x2', mouseX);
                    lineElement.setAttribute('y2', mouseY);

                    const dx = mouseX - startX;
                    const dy = mouseY - startY;
                    const distancePx = Math.sqrt(dx * dx + dy * dy);

                    textElement.innerHTML = `${pxToInches(distancePx)}"`;
                    textElement.setAttribute('x', mouseX + 15);
                    textElement.setAttribute('y', mouseY + 15);
                } else {
                    startX = mouseX; startY = mouseY;
                    lineElement.setAttribute('x1', startX);
                    lineElement.setAttribute('y1', startY);
                }
            }

            function onMouseUp(e) {
                activePiece = null;
                isMeasuring = false;
                lineElement.style.opacity = 0;
                textElement.style.opacity = 0;
            }

            function onWheel(e) {
                e.preventDefault();
                e.stopPropagation();
                const piece = e.currentTarget;
                let currentAngle = parseFloat(piece.dataset.angle) || 0;

                if (e.deltaY > 0) currentAngle += 15;
                else currentAngle -= 15;

                piece.dataset.angle = currentAngle;
                piece.style.transform = `rotate(${currentAngle}deg)`;
            }

            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);

            createUnits();

        </script>
    </body>

</html>